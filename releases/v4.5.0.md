# Release v4.5.0
Date: 2014-12-01

## Description

- Decrease of priority in parser's specialchars



- An important bug was fixed: the memory in the loops:

	In div 4.4 dont't work:

	index.php
	----
	<?php

	include "div.php";
	echo new div("test.tpl", array("cities" => array("Havana", "Tokyo")));

	index.tpl
	----
	{= foo: [
		{ title: "Cities",
		  content: '{% cities.tpl %}'
		}
	] =}

	{% layout.tpl %}

	layout.tpl
	-----
	?$foo
		[$foo]
			<h1>{$title}</h1>
			{$content}<br/>
		[/$foo]
	$foo?

	cities.tpl
	-----
	?$cities
		[$cities]
			{$value}
		[/$cities]
	@else@
		No cities
	$cities?

	Output (wrong!)
	-----
	<h1>Cities</h1>
	No cities<br/>

	Output (great in 4.5)
	-----
	<h1>Cities</h1>
	Havana Tokio<br/>



- bugfix: div::getFileContents()



- Improvement of global design vars in loops and capsules



- bugfix: div::fileExists and wrong include paths calculation



- Memory fixed!



- Some bugfixs
- Add new important security feature: setup literals items/vars, for prevent injections!

Example:

index.tpl
---------------
{= div.literals: ["text1", "text2"] =}	<!--{ in PHP div::addLiteral(array("text1","text2")); }-->

{$text1}

{$text2}

{$text3}

index.php
---------------
echo new div('index.tpl', array(
	'text1' => '{/ignore}[:1,5:] {$value} [/]{ignore}', // I am being about deceiving the security
	'text2' => '[:1,100;] text to repeat [/]',
	'text3' => '[:1,3;] some [/]'
));

output
---------------
[:1,5;] {$value} [/]
[:1,100;] text to repeat [/]
some some some



- Allow is_array PHP function in macros
- New method for add literal vars in PHP: div::addLiteral();



- Fix macros parsing when a previous template var never match



- Fix the memory in the loops



- Security fix: prevent obtrusive code in method calls. Now next code dont work:

{= content: ->getPage(file_put_contents('some.txt','some text')) =}



- New feature for preprocessed templates: specific data

  Syntax:

  {%% tpl_file: data %%}

  data is: json, name of var or filename with json

  Example:

  Now is more simple for build the components:

  index.tpl
  ------------
  {%% form: {
  		action: "login.php",
  		method: "post.php",
  		fields: [
  			{
  				type: "text",
  				name: "user",
  				label: "User"
  			},{
  				type: "password",
  				name: "pass",
  				label: "Password"
  			}
  		],
  		submit: {
  			value: "login",
  			name: "btnLogin"
  		}
  } %%}

  form.tpl
  ------------
  <form action="{$action}" method="{$method}">
  	[$fields]
  		{$label}:<br/>
  		<input type="{$type}" name="{$name}"><br/>
  	[/$fields]
  	<input type="submit" name="{$name}" value="{$value}">
  </form>



- bugfix: Parse pre-processed templates with all items/vars (Div doesn't know the future)



- bugfix: Adding items to array in templates

{= somearray[]: "new item" =}

- bugfix: Don't set item var as design var in div::parseData();



- bigfix: Save sections of loops and capsules when makeItAgain(); (Div doesn't know the future)


- big fix: Set the priority to inline data in pre-processed templates above global design vars
---
- bugfix/improve - Parsing orphan's parts while checksum not change. Do it because the orphans's parts stop the parser and the results are ugly.
---
- bugfix: Parsing macros inside preprocessed templates. New argument $min_level for parse() method.
- Add new allowed functions in macros, formulas and expressions: `array_keys` `get_object_vars` `is_object`
- new static method `div::div():`

index.php

```php
<?php
	echo div::div('index.tpl', array("item1" => "value1"));
```

- Allow T_BREAK token in macros for foreach and other loops. Then, the follow macro is an error:
index.tpl

```php
<? break; ?>
```

Output
```shell
Fatal error: Cannot break/continue 1 level in div.php: eval()'d code on line 1
```
---
- new feature: advanced options/params for includes

index.tpl
```
{% subtpl: {
	from: "<!--{ begin }-->",
	to: "<!--{ end }-->",
	offset: 2,
	limit: 1
} %}
```

subtpl.tpl

```
Any text...

<!--{ begin }-->Some text 1<!--{ end }-->

Any text...

<!--{ begin }-->Some text 2<!--{ end }-->

Any text
```

- bugfix: Preparing allowed methods before execute the macros
---
- bug fix in `parsePreprocessed()` when $pdata is null
- bug fix with number formats inside loops
---
- bugfix `parseData()` vs `parseMatch()` logical order
---
- new setup var: `div.clear_locations` (= true by default). This means that the locations will be clear or not at the end (parse_level = 0). Then, the component are more flexible with **pre-processed templates**:

comp.tpl

```html
(( before )) <input type="{$type}" name="{$name}"> (( after ))
```

index.tpl
```html
{%% comp: {
	type: "text",
	name: "first_name",
	div: {
		clear_locations: false
	}
} %%}

<!--{ If div.clear_locations is true (by default), the next code don't work }-->

{{before <label>First Name</label> before}}
{{after <input type="submit"> after}}
```

---
- improve performance changing $vars with `__temp['vars']` var in `parseMacros();` because because `get_defined_vars` return also `vars`
- prevent infinite loops in `div::cop();`
---
- improve `div::isValidPHPCode()`
---
- some bug fixes
- Release 4.5 version
---

## Commits
- No commits found.
